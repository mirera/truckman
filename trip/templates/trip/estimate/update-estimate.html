{% extends 'base.html' %}  

{% block content %}

<!-- displaying flash messages -->
{% if messages %}
{% for message in messages %}
    <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% else %}alert-primary{% endif %}">
        {{ message }}
    </div>
{% endfor %}
{% endif %} 
<!-- content @s -->
<div class="nk-content ">
    <div class="container-fluid">
        <div class="nk-content-inner">
            <div class="nk-content-body">
                <div class="nk-block-head nk-block-head-sm">
                    <div class="nk-block-between">
                        <div class="nk-block-head-content">
                            <h3 class="nk-block-title page-title">Update Quotation</h3>
                        </div><!-- .nk-block-head-content -->
                    </div><!-- .nk-block-between -->
                </div><!-- .nk-block-head -->
                <div class="nk-block">
                    <div class="card card-bordered">
                        <form action="{% url 'update_estimate' estimate.id %}" method="POST" enctype="multipart/form-data" >
                            {% csrf_token %}
                            <div class="card-inner">
                                <div class="nk-block">
                                    <div class="row gy-4">
                                        <div class="col-xxl-3 col-md-4">
                                            <div class="form-group">
                                                <label class="form-label" for="trip">Customer</label>
                                                <!--<input type="text" name="plate_number" class="form-control" id="name" placeholder="Registration Number" required> -->
                                                {{ form.customer }}
                                            </div>
                                        </div><!--col-->
                                        <div class="col-xxl-3 col-md-4">
                                            <div class="form-group">
                                                <label class="form-label" for="trip">Status</label>
                                                <!--<input type="text" name="plate_number" class="form-control" id="name" placeholder="Registration Number" required> -->
                                                {{ form.status }}
                                            </div>
                                        </div><!--col-->
                                        <div class="col-xxl-3 col-md-4">
                                            <div class="form-group">
                                                <label class="form-label">Valid Till</label>
                                                <div class="form-control-wrap">
                                                    <div class="form-icon form-icon-right">
                                                        <em class="icon ni ni-calendar"></em>
                                                    </div>
                                                    <!--<input type="text" name="insurance_expiry" class="form-control date-picker" data-date-format="yyyy-mm-dd" placeholder="yyyy-mm-dd">-->
                                                    {{ form.valid_till }}
                                                </div>
                                            </div>
                                        </div><!--col-->
                                        <div class="col-xxl-2 col-md-2">
                                            <div class="form-group">
                                                <label class="form-label" for="taxPc">Discount %</label>
                                                <input type="number" name="discountpc" class="form-control" id="discountPc" value="" >
                                            </div>
                                        </div><!--col-->
                                        <div class="col-xxl-2 col-md-2">
                                            <div class="form-group">
                                                <label class="form-label" for="taxPc">Tax (%)</label>
                                                <input type="number" name="taxPc" class="form-control" id="taxPc" value="" >
                                            </div>
                                        </div><!--col-->
                                    </div><!--row-->
                                </div>
                            </div>
                            <div class="card-inner">
                                <div class="nk-block">
                                    <div class="row gy-4">
                                        <div class="col-xxl-3 col-md-4">
                                            <a href="#" id="addItem" class="btn btn-sm btn-outline-primary addItem"><span>Add Item</span></a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-inner third-card-inner">
                                <div class="nk-block">
                                    <div class="row gy-4">
                                        <div class="col-xxl-3 col-md-3">
                                            <div class="form-group">
                                                <label class="form-label" for="name">Item</label>
                                                {{ form.item }}
                                            </div>
                                        </div><!--col-->
                                        <div class="col-xxl-2 col-md-2">
                                            <div class="form-group">
                                                <label class="form-label" for="quantity">Route</label>
                                                {{ form.route }}
                                            </div>
                                        </div><!--col-->
                                        <div class="col-xxl-3 col-md-2">
                                            <div class="form-group">
                                                <label class="form-label" for="unitPrice">Rate</label>
                                                <input type="text" name="rate" class="form-control" id="routeRate" value="{{ estimate.rate }}" >
                                            </div>
                                        </div><!--col-->
                                        <div class="col-xxl-2 col-md-2">
                                            <div class="form-group">
                                                <label class="form-label" for="numberTrucks">Truck(s)</label>
                                                <input type="number" name="trucks" class="form-control" id="numberTrucks" value="{{ estimate.trucks }}" >
                                            </div>
                                        </div><!--col-->
                                        <div class="col-xxl-3 col-md-2">
                                            <div class="form-group">
                                                <label class="form-label" for="amount">Amount</label>
                                                <input type="number" name="amount" class="form-control" id="amount" value="{{ estimate.sub_total }}" readonly >
                                            </div>
                                        </div><!--col-->
                                        <div class="col-xxl-3 col-md-1">
                                            <div class="form-group">
                                                <label class="form-label" for="amount">Remove</label>
                                                <a href="#" class="btn btn-danger" id="removeItem"><em class="icon ni ni-cross-round"></em></a>
                                            </div>
                                        </div><!--col-->
                                        <!-- 
                                        <div class="col-xxl-3 col-md-6">
                                            <div class="form-group">
                                                <label class="form-label" for="description">Description</label>
                                                {{ form.description }}
                                            </div>
                                        </div>--col-->
                                    </div><!--row-->
                                </div>
                            </div>
                            <div class="card-inner">
                                <div class="nk-block ">
                                    <div class="row gy-4 justify-content-end">
                                        <div class="col-xxl-3 col-md-2">
                                            <div class="form-group">
                                                <label class="form-label fw-medium" for="subTotal">Sub Total</label>
                                                <input type="number" name="sub_total" class="form-control fw-medium" id="subTotal" value="{{ estimate.sub_total }}" readonly>
                                            </div>
                                        </div><!--col-->
                                        <div class="col-xxl-3 col-md-2">
                                            <div class="form-group">
                                                <label class="form-label" for="discount">Discount</label>
                                                <input type="number" name="discount" class="form-control" id="discount" value="{{ estimate.discount }}" readonly>
                                            </div>
                                        </div><!--col-->
                                        <div class="col-xxl-3 col-md-2">
                                            <div class="form-group">
                                                <label class="form-label" for="tax">Tax</label>
                                                <input type="number" name="tax" class="form-control" id="tax" value="{{ estimate.tax }}" readonly>
                                            </div>
                                        </div><!--col-->
                                        <div class="col-xxl-3 col-md-2">
                                            <div class="form-group">
                                                <label class="form-label text-uppercase fw-bold" for="grandTotal">Total</label>
                                                <input type="number" name="total" class="form-control text-uppercase fw-bold" id="grandTotal" value="{{ estimate.total }}" readonly>
                                            </div>
                                        </div><!--col-->
                                    </div><!--row-->
                                </div>
                            </div>
                            <div class="card-inner">
                                <div class="nk-block">
                                    <div class="row gy-4">
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label class="form-label" for="name">Note</label>
                                                <!--<input type="text" name="plate_number" class="form-control" id="name" placeholder="Registration Number" required> -->
                                                {{ form.note }}
                                            </div>
                                        </div><!--col-->
                                        <div class="col-12">
                                            <div class="form-group">
                                                <button type="submit" class="btn btn-primary">Save Estimate</button>
                                            </div>
                                        </div><!--col-->
                                    </div><!--row-->
                                </div>
                            </div>
                        </form>
                        </div><!-- .card-inner-group -->
                    </div><!-- .card -->
                </div><!-- .nk-block -->
            </div>
        </div>
    </div>
</div>
<!-- content @e -->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- click on add item to clone item section-->
<script>
    $(document).ready(function() {
        // Counter for unique IDs
        let itemCount = 1;

        // Function to add a new item block
        function addNewItem() {
            const newItem = $('.third-card-inner:first').clone();
            
            // Increment IDs within the cloned div
            newItem.find('[id]').each(function() {
                const oldId = $(this).attr('id');
                $(this).attr('id', oldId + itemCount);
            });

            // Increment the global item count
            itemCount++;

            // Append the cloned div below the last card-inner
            $('.third-card-inner:last').after(newItem);
            
            // Add functionality to remove the new item
            newItem.find('#removeItem').click(function() {
                newItem.remove();
            });
        }

        // Add functionality to the "Add Item" button
        $('#addItem').click(function() {
            addNewItem();
        });
    });
</script>

<!-- autofill inputs on estimate form -->
<script>
    $(document).ready(function() {
        // Function to calculate and update values
        function updateInvoice() {
            var quantity = parseFloat($('#numberTrucks').val()) || 0;
            var unitPrice = parseFloat($('#routeRate').val()) || 0;
            var taxPc = parseFloat($('#taxPc').val()) || 0;
            var discountPc = parseFloat($('#discountPc').val()) || 0;
            
            var amount = quantity * unitPrice;
            var subTotal = amount;
            var discount = (discountPc / 100) * subTotal;
            var tax = (taxPc / 100) * subTotal;
            var grandTotal = subTotal - discount + tax;
    
            // Update the fields
            $('#amount').val(amount.toFixed(2));
            $('#subTotal').val(subTotal.toFixed(2));
            $('#discount').val(discount.toFixed(2));
            $('#tax').val(tax.toFixed(2));
            $('#grandTotal').val(grandTotal.toFixed(2));
        }
    
        // Attach the function to input change events
        $('#numberTrucks, #routeRate, #taxPc, #discountPc').on('input', updateInvoice);
    });
</script>
<!-- ends -->  

<!-- get trip details on choosing a trip -->
<script>
    $(document).ready(function () {
        // Get references to the input fields and select field
        var tripSelect = $("#trip");
        var vehicleInput = $("#vehicle");
        var customerInput = $("#customer");

        // Add an event listener to the "Trip" select field
        tripSelect.on("change", function () {
            // Get the selected trip ID
            var tripId = $(this).val();

            // Send a GET request to fetch vehicle and customer information
            $.get("/trip/get_trip_info/" + tripId, function (data) {
                // Update the vehicle and customer input fields with the fetched data
                vehicleInput.val(data.vehicle);
                customerInput.val(data.customer);
            });
        });
    });
</script>
<!-- end -->

{% endblock content %}